function close_data(){data_container.open=!1,$(dbody).removeClass("data_mode")}function open_data(){data_container.open=!0,$(dbody).addClass("data_mode")}function open_floating(e){close_floatings(),$(e).addClass("on"),e.list.open=!0,$(e.list).addClass("open")}function close_floatings(){$(indicators_bt).removeClass("on"),$(areas_bt).removeClass("on"),$(area_filters).removeClass("open"),$(category_filter).removeClass("open"),area_filters.open=!1,category_filter.open=!1,AREA.current_list&&hide_list(AREA.current_list)}function check_filters(){CATEG.id>0||AREA.id>0?$(clear_filters).removeClass("off"):$(clear_filters).addClass("off")}function open_layers(){layers.open=!0,$(dbody).addClass("layers_mode"),resize_map(animate2)}function close_layers(){layers.open=!1,$(dbody).removeClass("layers_mode"),resize_map(animate2)}function close_layer(e){e.open=!1,$(e).removeClass("open")}function open_layer(e){reset_layers(),e.open=!0,$(e).addClass("open")}function create_layer(e){var a=elem("li",{id:"layer_"+e.id,trg:layers_list});$(a).addClass("layer").addClass("animate"),a.open=!1,a.off=!1,a.obj=e,layers_list.prepend(a);var t=elem("div",{trg:a});$(t).addClass("lb1").addClass("animate1").html(e.ano),a.label1=t;var i=elem("div",{trg:a});$(i).addClass("lb2").addClass("animate1").html(e.nome),a.label2=i;var r=elem("div",{trg:a});$(r).addClass("eye").addClass("animate1").addClass("icon15").append(icons.eye).on("click",function(){this.layer.off?(this.layer.off=!1,$(this.layer).removeClass("off"),toggle_layer(this.obj,!0)):(this.layer.off=!0,$(this.layer).addClass("off"),toggle_layer(this.obj,!1),this.layer.open&&close_layer(this.layer))}),r.layer=a,r.obj=e;var l=elem("div",{trg:a});$(l).addClass("arrow").addClass("animate1").addClass("icon15").append(icons.down);var s=elem("div",{trg:a});$(s).addClass("handle").addClass("icon15").append(icons.hamburguer);var n=elem("div",{trg:a});$(n).addClass("layer_content").addClass("animate2"),a.content=n;var o=elem("img",{trg:n});$(o).attr("src","http://m2.lapig.iesa.ufg.br/ows?EXCEPTIONS=application%2Fvnd.ogc.se_xml&TRANSPARENT=TRUE&VERSION=1.1.1&SERVICE=WMS&REQUEST=GetLegendGraphic&LAYER="+e.id+"&format=image%2Fpng");var c=elem("div",{cls:"op_slider",trg:n}),d=(elem("div",{cls:"op_track",trg:c}),elem("div",{cls:"op_label",trg:c,html:language.opacity[lang]}),elem("div",{cls:"ui-slider-handle",trg:c,html:"100%"}));$(c).slider({value:100,slide:function(e,a){$(d).text(a.value+"%"),a.handle.wms_layer.setOpacity(a.value/100)}});var _=elem("div",{trg:n,cls:"remove",html:language.remove[lang]});$(_).on("click",function(){var e=this.ID;$(DATA.list).each(function(a,t){t.id==e&&toggle_check_indicator(t)})}),_.ID=e.id;var m=elem("div",{trg:n,cls:"download",html:language.download[lang]});$(m).on("click",function(){console.log("!!download "+this.ID)}),m.ID=e.id;var g=elem("div",{trg:a});$(g).addClass("layer_hit").on("click",function(){this.layer.open?close_layer(this.layer):this.layer.off||open_layer(this.layer)}),g.layer=a;var u='"[ANO]"="'+e.ano+'"';console.log("ms_filter"),console.log(u);var p=L.tileLayer.wms("http://maps.lapig.iesa.ufg.br/ows?",{layers:e.id,format:"image/png",transparent:!0,width:512,height:512,srs:"EPSG:900913",MSFILTER:u,updateWhenIdle:!0});map.addLayer(p),p.obj=e,p.layer=a,map_itens.push(p),p.setZIndex(map_itens.length),$(layers_list).sortable("refresh"),d.wms_layer=p}function remove_layer(e){$(map_itens).each(function(a,t){t.obj==e&&($(t.layer).remove(),t.layer=null,map.removeLayer(t),map_itens.splice(map_itens.indexOf(t),1),t=null)})}function toggle_layer(e,a){$(map_itens).each(function(t,i){i.obj==e&&(a?map.addLayer(i):map.removeLayer(i))})}function search_indicator(e){var a;return $(DATA.list).each(function(t,i){e.region==i.region&&e.regionType==i.regionType&&e.id==i.id&&(a=i)}),a}function normalize_categs(e){var a=[];return $(e).each(function(e,t){a.push(removeAccents(t.toLowerCase()))}),a}function get_area_label(e,a){var t="";if("brasil"==e)t=language.brasil[lang].toUpperCase();else switch(convert_lb(e)){case"Estados":$(AREA.json.Estados).each(function(e,i){a==i.UF&&(t=i.ESTADO)});case"Municipios":case"Biomas":case"Regioes":case"Bacias":}return t}function convert_lb(e){switch(e){case"estado":return"Estados";case"municipio":return"Municipios";case"bioma":return"Biomas";case"regiao":return"Regioes";case"bacia":return"Bacias"}}function indicator_data(e,a,t){e.ano=a.reverse(),e.valor=t.reverse(),e.val_id=0,e.ano.length>1?$(e.year).addClass("plus").html(e.ano[0]+" (+)"):$(e.year).html(e.ano[0]),$(e.data_select).html(null),$(e.ano).each(function(a,t){var i=elem("option",{trg:e.data_select,cls:"data_opt"});$(i).html(t).attr("value",a),0==a&&$(i).attr("selected","selected")}),$(e.data).html(format_number(e.valor[0])+" "+e.unidade)}function create_indicator(e){var a=elem("li",{trg:indicators_list,cls:"indicator animate2"});a.open=!1,a.selected=!1,a.id=e.id,a.nome=e.nome,a.descricao=e.descricao,a.categ=normalize_categs(e.categ),a.unidade=e.unidade,a.tipo=e.tipo,DATA.list.push(a);var t=elem("div",{trg:a,cls:"icon check animate1 icon20"});$(t).append(icons.cCheckFull),$(t).on("click",function(){toggle_check_indicator(this.indicator)}),t.indicator=a;var i=elem("div",{trg:a,cls:"hit"});$(i).on("click",function(){toggle_open_indicator(this.indicator)}),i.indicator=a;var r=elem("label",{trg:a,cls:"animate1 title"});elem("span",{trg:r,html:e.nome});title_div=elem("span",{trg:r,html:" | "});var l=elem("span",{trg:r});a.year=l;var s=elem("label",{trg:a,cls:"animate1 data"});a.data=s;var n=elem("div",{trg:a,cls:"icon arrow animate1 icon15"});$(n).append(icons.down);var o=elem("div",{trg:a,cls:"data_box"});a.data_box=o;var c=elem("div",{trg:o,cls:"data_description"});$(c).html(e.descricao);var d=elem("div",{trg:o,cls:"data_box_bts"}),_=elem("select",{trg:d,cls:"data_select animate2"});$(_).attr("tabindex",-1).on("change",function(){var e=$(this).val();this.indicator.val_id=e,$(this.indicator.data).html(format_number(this.indicator.valor[e])+" "+a.unidade),$(this.indicator.year).html(a.ano[e]+" (+)")}),_.indicator=a,a.data_select=_;var m=elem("div",{trg:d,cls:"data_select_icon icon15"});$(m).append(icons.down);var g=elem("div",{trg:d,cls:"data_add animate2"});$(g).on("click",function(){toggle_check_indicator(this.indicator)}),g.indicator=a,a.data_add=g;var u=(elem("span",{trg:g,cls:"lb_off lg_add_to_report",html:"INCLUIR "}),elem("span",{trg:g,cls:"lb_on lg_remove_from_report",html:" REMOVER"}),elem("div",{trg:g,cls:"icon icon15 animate2"}));$(u).append(icons.plus),indicator_data(a,e.ano,e.valor)}function toggle_open_indicator(e){e.open?close_indicator(e):(reset_indicators(),open_indicator(e))}function open_indicator(e){e.open=!0,$(e).addClass("open").css({height:130+$(e.data_box).height()})}function close_indicator(e){e.open=!1,$(e).removeClass("open").css({height:""})}function reset_indicators(){$(DATA.list).each(function(e,a){a.open&&close_indicator(a)})}function reset_layers(){$(map_itens).each(function(e,a){close_layer(a.layer)})}function set_indicator(e,a){e.selected=a,a?$(e).addClass("selected"):$(e).removeClass("selected")}function toggle_check_indicator(e){e.selected?(set_indicator(e,!1),blink("out")):(set_indicator(e,!0),blink("in")),update_report(e)}function update_report(e){if(e.selected){var a={id:e.id,anos:e.ano,ano:e.ano[e.val_id],valores:e.valor,valor:e.valor[e.val_id],unidade:e.unidade,descricao:e.descricao,nome:e.nome};create_layer(a),report.list.push(a)}else console.log("remove"),$(report.list).each(function(a,t){t.id==e.id&&(remove_layer(t),remove_report(t),report.list.splice(a,1),t=null)});check_categ(),console.log("update_report: ",report),sessionStorage.setItem("report",JSON.stringify(report)),count_report(),check_layers()}function remove_report(e){}function create_report(e){var a=elem("li",{trg:report_ul,cls:"indicator"});a.obj=e;var t=(elem("div",{trg:a,cls:"report_hr",html:"&mdash;"}),elem("div",{trg:a,cls:"header"}));elem("div",{trg:t,cls:"title",html:e.nome+" | "+e.ano[e.val_id]}),elem("div",{trg:t,cls:"data",html:format_number(e.valor[e.val_id])+" "+e.unidade}),elem("div",{trg:a,cls:"text",html:e.descricao});if(e.ano.length>1){var i=elem("div",{trg:a,cls:"evolution"});i.max=0,i.itens=[],$(e.ano).each(function(a,t){i.max<e.valor[a]&&(i.max=e.valor[a]);var r=elem("div",{trg:i,cls:"ano"}),l=(elem("div",{trg:r,cls:"ano_lb",html:t}),elem("div",{trg:r,cls:"bar"}));elem("div",{trg:r,cls:"label",html:format_number(e.valor[a])+" "+e.unidade});a==e.val_id&&$(r).addClass("selected"),r.bar=l,r.val=e.valor[a],i.itens.push(r)}),i.max*=1.1,$(i.itens).each(function(e,a){$(a.bar).css({width:a.val/i.max*100+"%"})})}elem("div",{trg:a,cls:"ranking",html:"ranking de municÃ­pios"});report_ul.append(a)}function check_layers(){report.list.length>0?($(msg_layers).hide(),$(msg_report).hide(),$(layers_list).show(),$(sort_layers_msg).show()):($(msg_layers).show(),$(msg_report).show(),$(layers_list).hide(),$(sort_layers_msg).hide())}function blink(e){$(report_bt).addClass("blink "+e),$(layers_bt).addClass("blink "+e),setTimeout(function(){$(report_bt).removeClass("blink "+e),$(layers_bt).removeClass("blink "+e)},animate2)}function close_report(){report_container.open=!1,$(report_container).removeClass("open"),$(report_bt_label).text(language.generate_report[lang])}function generate_report(){$(report_ul).html(null),$(DATA.list).each(function(e,a){a.selected&&create_report(a)}),report_container.open=!0,$(report_container).addClass("open"),$(report_bt_label).text(language.close_report[lang])}function check_session_report(){var e=sessionStorage.getItem("report");e&&(report=JSON.parse(e)),report.list.length>0&&($(report.list).each(function(e,a){create_layer(a)}),blink("in"))}function check_indicators_on(){$(report.list).each(function(e,a){$(DATA.list).each(function(e,t){a.id==t.id&&set_indicator(t,!0)})})}function count_report(){$(layers_counter).html(report.list.length),$(report_bt_counter).html(report.list.length)}function create_categ_filter(e,a,t){var i=elem("li",{trg:category_filter_ul});$(i).addClass("filter").addClass("animate1").addClass(t?" selected":"").html(language[a][lang]).on("click",function(){set_categ_filter(this)}),i.ID=e,i.categ=a,i.lb=language[a][lang],CATEG.itens.push(i)}function set_categ_filter(e){CATEG.id=e.ID,CATEG.name=e.categ,$(CATEG.itens).each(function(a,t){a==e.ID?$(t).addClass("selected"):$(t).removeClass("selected")}),check_categ(),$(indicators_bt_lb2).html(e.lb),close_floatings(),check_filters()}function check_categ(){var e=0;$(DATA.list).each(function(a,t){0==CATEG.id?($(t).removeClass("hide"),e++):1==CATEG.id?t.selected?($(t).removeClass("hide"),e++):$(t).addClass("hide"):t.categ.indexOf(CATEG.name)<0?$(t).addClass("hide"):($(t).removeClass("hide"),e++)}),e>0?$(msg_indicators).hide():$(msg_indicators).show()}function submit_search(e){var a=search.value;if(""!=a){$(search_bt).hide(),$(search_cancel_bt).show(),$(municipios_ul).html(null),console.log("search_for: ",a);var t=removeSpaces(removeAccents(a.toLowerCase()),"-"),i=JSON.search(AREA.municipios,'//list[contains(index,"'+t+'")]');search_results=elem("li",{trg:municipios_ul,id:"search_results"}),$(search_results).html("&raquo; "+i.length+' resultado(s) para "'+a+'"'),$(i).each(function(e,a){area_filter_li(a.uf+" - "+a.nome,municipios_ul,!1,"municipio",a.cod_mu)})}}function reset_search(){$(municipios_ul).html(null),$(search_results).hide(),$(search_cancel_bt).hide(),$(search_bt).show(),search.value="",$(AREA.municipios.list).each(function(e,a){area_filter_li(a.uf+" - "+a.nome,municipios_ul,!1,"municipio",a.cod_mu)})}function hide_list(e){e.trava||($(e).removeClass("show"),e.trava=!0,setTimeout(function(){$(e).hide(),e.trava=!1},animate4)),AREA.current_list=!1}function show_list(e){e.trava||($(e).show(),e.trava=!0,setTimeout(function(){$(e).addClass("show")},10),setTimeout(function(){e.trava=!1},animate4))}function create_area_list(e,a,t){AREA.current_list=!1;var i=elem("div",{trg:area_filters,cls:"floating_list list_container animate2"});$(i).hide(),area_filter_li(language[a.toLowerCase()][lang],e,i,!1,!1);var r=elem("div",{trg:i,cls:"floating_list_back"});r.container=i,r.bt_lb=a,$(r).on("click",function(){hide_list(this.container)}).mouseenter(function(){$(this.label).text(language.back[lang])}).mouseleave(function(){$(this.label).text(language[this.bt_lb.toLowerCase()][lang])});var l=(elem("div",{trg:r,cls:"animate1 icon icon15",apd:icons.left}),elem("label",{trg:r,cls:"animate1",html:language[a.toLowerCase()][lang]}));r.label=l;var s=elem("ul",{trg:i,cls:"floating_list list_content"});switch($(s).css({top:80,paddingTop:20,height:"calc(100% - 80px)"}),a){case"Estados":sort_on(t,"ESTADO",!1,!1),$(t).each(function(e,a){area_filter_li(a.ESTADO,s,!1,"estado",a.UF)});break;case"Municipios":$(s).css({top:80,paddingTop:20,height:"calc(100% - 160px)"}),municipios_ul=s,search_container=i;var n=elem("input",{trg:i,id:"search"});$(n).attr("placeholder",language.search_city[lang]),search_bt=elem("div",{trg:i,id:"search_bt"}),$(search_bt).on("click",function(){submit_search()});var o=(elem("label",{trg:search_bt,cls:"animate1 bt_label",html:language.search[lang]}),elem("div",{trg:search_bt,cls:"icon icon25 animate1 bt_icon"}));$(o).append(icons.lupa),search_cancel_bt=elem("div",{trg:i,id:"search_cancel_bt"}),$(search_cancel_bt).on("click",function(){reset_search()}),$(search_cancel_bt).hide();var o=(elem("label",{trg:search_cancel_bt,cls:"animate1 bt_label",html:language.cancel[lang]}),elem("div",{trg:search_cancel_bt,cls:"icon icon25 animate1 bt_icon"}));$(o).append(icons.x),$(n).on("focus",function(){n.focus=!0}),$(n).on("blur",function(){n.focus=!1});for(var c in t)$(t[c]).each(function(e,a){var t=area_filter_li(c+" - "+a.nome,s,!1,"municipio",a.cod_mu),i={};i.li=t,i.uf=c,i.nome=a.nome,i.codigo=a.cod_mu,i.index=removeSpaces(removeAccents(a.nome.toLowerCase()),"-"),AREA.municipios.list.push(i)});break;case"Biomas":sort_on(t,"BIOMA",!1,!1),$(t).each(function(e,a){area_filter_li(a.BIOMA,s,!1,"bioma",a.BIOMA)});break;case"Regioes":sort_on(t,"nome",!1,!1),$(t).each(function(e,a){area_filter_li(a.nome,s,!1,"regiao",a.nome)});break;case"Bacias":}}function area_filter_li(e,a,t,i,r){var l=elem("li",{trg:a});if($(l).addClass("filter").addClass("animate1").html(e).on("click",function(){this.list?call_area_list(this.list):set_area_filter(this)}),t){var s=elem("div",{trg:l,cls:"go icon15"});$(s).append(icons.right)}return l.lb=e,l.list=t,l.regionType=i,l.region=r,AREA.itens.push(l),l.ID=AREA.itens.indexOf(l),l}function call_area_list(e){show_list(e),AREA.current_list=e}function set_area_filter(e){console.log("set_area_filter: "+e.lb),console.log(e);var a=e.ID;AREA.id=a,$(AREA.itens).each(function(e,t){e==a?$(t).addClass("selected"):$(t).removeClass("selected")}),$(areas_bt_lb2).html(e.lb),close_floatings(),check_filters();var t="data/lista";"brasil"!=e.regionType&&(t+="_"+e.regionType),"brasil"!=e.region&&(t+="_"+e.region),t+=".json",ajax(t,DATA,"update_indicators_data",[e.regionType,e.region]),"brasil"!=e.regionType?$(report_category).html(e.regionType):$(report_category).html(""),$(report_area).html(e.lb.toLowerCase())}function convert_lang(e){switch(e){case"_pt":return"pt-bt";case"_en":return"en-us"}}console.log("--- module: map.js"),set("data_bt"),set("data_container"),set("indicators_bt"),set("areas_bt"),set("clear_filters"),set("filters"),set("category_filter"),set("area_filters"),set("report_bt"),set("map_report"),set("report_ul");var map_itens=[],report_itens=[];$(dbody).addClass("data_mode"),data_container.open=!0,$(data_bt).on("click",function(){data_container.open?close_data():open_data(),resize_map(animate2)}),$(indicators_bt).on("click",function(){this.list.open?close_floatings():open_floating(this)}),$(clear_filters).on("click",function(){close_floatings(),set_area_filter(area_brasil),set_categ_filter(CATEG.itens[0])}),$(areas_bt).on("click",function(){this.list.open?close_floatings():open_floating(this)}),indicators_bt.list=category_filter,areas_bt.list=area_filters;var layers=elem("div",{trg:dbody});$(layers).attr("id","layers").addClass("l1").addClass("animate2"),layers.open=!1;var layers_bt=elem("div",{trg:map_controls});$(layers_bt).attr("id","layers_bt").addClass("animate1").on("click",function(){open_layers()});var icon1=elem("div",{id:"layers_bt_icon1",trg:layers_bt});$(icon1).addClass("layer_icon").addClass("animate1").addClass("icon25").append(icons.layers);var label=elem("span",{cls:"lg_layers",id:"layers_bt_label",trg:layers_bt,html:language.layers[lang]}),layers_counter=elem("span",{id:"layers_counter",cls:"counter animate1",trg:layers_bt}),layers_top=elem("div",{id:"layers_top",cls:"animate1",trg:layers});$(layers_top).on("click",function(e,a){close_layers()});var icon2=elem("div",{id:"layers_top_icon",cls:"layer_bt_icon",trg:layers_top});$(icon2).addClass("layer_icon").addClass("animate1").addClass("icon25").append(icons.layers);var label2=elem("div",{id:"layers_top_label",trg:layers_top,html:language.layers[lang]}),icon3=elem("div",{id:"layers_top_x",cls:"icon15 layer_bt_icon",trg:layers_top});$(icon3).append(icons.right);var layers_list=elem("ul",{id:"layers_list",cls:"",trg:layers});$(layers_list).sortable({axis:"y",handle:".handle",revert:100,scrollSensitivity:10,scrollSpeed:20,update:function(e,a){var t=$(layers_list).sortable("toArray");$(t).each(function(e,a){var i=get(a);$(map_itens).each(function(a,r){r.obj==i.obj&&r.setZIndex(t.length-e)})})}}).disableSelection();var msg_layers=elem("div",{cls:"no_indicators_msg",trg:layers});$(msg_layers).html(language.no_indicators[lang]);var msg_indicators=elem("li",{cls:"no_indicators_msg",trg:indicators});$(msg_indicators).html(language.no_indicators[lang]);var msg_report=elem("li",{cls:"no_indicators_msg",trg:report_ul});$(msg_report).html(language.no_indicators[lang]);var sort_layers_msg=elem("div",{id:"sort_layers_msg",trg:layers});$(sort_layers_msg).html(language.sort_msg[lang]),set("clear_report"),$(clear_report).on("click",function(){$(report_ul).html(null),$(DATA.list).each(function(e,a){a.selected&&toggle_check_indicator(a)})});var DATA={};set("indicators_list"),DATA.list=[],DATA.categs=["all","selected"],DATA.create_indicators_list=function(){$(DATA.json).each(function(e,a){create_indicator(a),$(a.categ).each(function(e,a){var t=removeAccents(a.toLowerCase());DATA.categs.indexOf(t)<0&&DATA.categs.push(t)})}),CATEG.itens=[],$(DATA.categs).each(function(e,a){var t=removeAccents(a.toLowerCase());create_categ_filter(e,t,!1)}),set_categ_filter(CATEG.itens[0]),check_indicators_on()},DATA.update_indicators_data=function(e,a){console.log("update_indicators_data!!"),$(DATA.list).each(function(e,a){$(DATA.json).each(function(e,t){a.id==t.id&&indicator_data(a,t.ano,t.valor)})})},set("report_ul"),set("report_container"),set("report_bt_label"),set("report_category"),set("report_area"),$(report_bt).on("click",function(){report_container.open?close_report():(generate_report(),close_floatings())});var report={list:[]};set("category_filter"),set("category_filter_ul"),set("indicators_bt_lb2");var CATEG={};CATEG.itens=[],CATEG.id=0,set("area_filters"),set("area_main_list"),set("area_main_ul"),set("areas_bt_lb2");var AREA={};AREA.itens=[],AREA.municipios={},AREA.municipios.list=[],AREA.id=0;var d,m,area_brasil,search_bt,search_cancel_bt,search_results,search_container,municipios_ul;AREA.load_floating_lists=function(){area_brasil=area_filter_li(language.brasil[lang],area_main_ul,!1,"brasil","brasil");for(d in AREA.json){var e=removeAccents(d);create_area_list(area_main_ul,e,AREA.json[d],!0)}var a="data/lista.json";ajax(a,DATA,"create_indicators_list",[]),set_area_filter(area_brasil)};var results=0;window.onkeydown=function(e){""!=search.value&&search.focus&&(27==e.which&&(search.value=""),13==e.which&&submit_search())},ajax("data/regions.json",AREA,"load_floating_lists",[]),initMap(),check_session_report(),count_report(),check_filters(),check_layers(),console.log("session_report: ",report);